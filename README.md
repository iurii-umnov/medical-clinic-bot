# Telegram BOT for Medical Clinic ü§ñ

## Description
This bot is developed to improve customer service of private medical clinic.

##### Client functionality
- Request a callback
- Request an appointment in clinic
- Get an online-consultation with doctor
- See all contacts and links of the clinic

##### Admin functionality
- Manage catalog content (create/delete doctors, update information)
- See bot usage statistic
- Manage admins list and their privileges


## Features
- Asynchronous work with ACID database
- Quick migrations
- Keeping Finite-State Machine states and state data across bot restarts
- Caching to reduce load on the main (ACID) database
- Multi-level administration with different privileges (accesses)
- Admin actions logging
- Link generation through parsing a website for online conferences (SberJazz)
- Daily health check of parser
- Statistic scheduler which automatically sends statistics to the admin chat every week/month/quarter/year
- Protection of functionality and content from users who have been deprived of admin privileges
- Integration with built-in Telegram payment (YooKassa)


## Tech
Bot uses a number of open source projects to work properly:

- [Python] - the main language of the project
- [Aiogram] - telegram bot functionality
- [SQLAlchemy] - database interaction
- [Alembic] - database migrations
- [MySQL] - content storage (main database)
- [Redis] - Finite-State Machine storage
- [Memcached] - caching
- [Selenium] - parsing (video conference link generation)


## Migrations
When you set up project you need to initialize the initial version of the database, i.e. create the tables from the scheme.
1. First of all, you need to create revision file (apply autorevision):
    ```
    alembic revision --autogenerate -m 'Init'
    ```
2. Secondly, you have to upgrade database to a final version with command:
    ```
    alembic upgrade head
    ```
üëç **Done!** üëç

Originally, there wasn't **migrations/** folder in this project as well as **alembic.ini** file. They were generated by the command
```
alembic init migrations
```
and, then, edited to the current version.


## Using PostgreSQL
If you want to use other relational database as a main content storage you need to keep in mind several changes that should be applied. Here are steps you must take to use PostgreSQL instead of MySQL:
1. Install libraries "_asyncpg_" and "_py-postgresql_" to work asynchronously with PostgreSQL:
    ```
    pip3 install asyncpg py-postgresql
    ```
2. Uninstall libraries related to MySQL:
    ```
    pip3 uninstall aiomysql pymysql
    ```
3. Change prefix of DB_URL in **src/core/secrets.py** from "_mysql+aiomysql_" to "_postgresql+asyncpg_"
4. Change function "_json_arrayagg_" to "_array_agg_" in **src/db/query.py** bacause PostgreSQL doesn't support "_json_arrayagg_" function and vice versa MySQL doesn't support "_array_agg_" function from SQLAlchemy.
5. Remove "_literal_eval_" in **src/handlers/admin/show_doctor.py** and in **src/handlers/admin/update_doctor.py**. This thing is closely connected with the previous point and allows to parse array from a string when we use "_json_arrayagg_" for MySQL.

üëç **Done!** üëç


[//]: # (These are reference links used in the body of this note and get stripped out when the markdown processor does its job.)

  [Python]: <https://www.python.org/>
  [Aiogram]: <https://docs.aiogram.dev/en/latest/index.html>
  [SQLAlchemy]: <https://www.sqlalchemy.org/>
  [Alembic]: <https://alembic.sqlalchemy.org/en/latest/>
  [MySQL]: <https://dev.mysql.com/doc/>
  [Redis]: <https://redis.io/>
  [Memcached]: <https://memcached.org/>
  [Selenium]: <https://selenium-python.readthedocs.io/>